"use strict";var RTCPeerConnection=null;var getUserMedia=null;var attachMediaStream=null;var reattachMediaStream=null;var webrtcDetectedBrowser=null;var webrtcDetectedVersion=null;function trace(a){if(a[a.length-1]==="\n"){a=a.substring(0,a.length-1)}console.log((window.performance.now()/1000).toFixed(3)+": "+a)}function maybeFixConfiguration(b){if(!b){return}for(var a=0;a<b.iceServers.length;a++){if(b.iceServers[a].hasOwnProperty("urls")){b.iceServers[a].url=b.iceServers[a].urls;delete b.iceServers[a].urls}}}if(navigator.mozGetUserMedia){console.log("This appears to be Firefox");webrtcDetectedBrowser="firefox";webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10);RTCPeerConnection=function(a,b){maybeFixConfiguration(a);return new mozRTCPeerConnection(a,b)};window.RTCSessionDescription=mozRTCSessionDescription;window.RTCIceCandidate=mozRTCIceCandidate;getUserMedia=navigator.mozGetUserMedia.bind(navigator);navigator.getUserMedia=getUserMedia;window.createIceServer=function(b,f,a){var d=null;var e=b.split(":");if(e[0].indexOf("stun")===0){d={url:b}}else{if(e[0].indexOf("turn")===0){if(webrtcDetectedVersion<27){var c=b.split("?");if(c.length===1||c[1].indexOf("transport=udp")===0){d={url:c[0],credential:a,username:f}}}else{d={url:b,credential:a,username:f}}}}return d};window.createIceServers=function(d,f,a){var e=[];for(var b=0;b<d.length;b++){var c=window.createIceServer(d[b],f,a);if(c!==null){e.push(c)}}return e};attachMediaStream=function(a,b){console.log("Attaching media stream");a.mozSrcObject=b};reattachMediaStream=function(b,a){console.log("Reattaching media stream");b.mozSrcObject=a.mozSrcObject}}else{if(navigator.webkitGetUserMedia){console.log("This appears to be Chrome");webrtcDetectedBrowser="chrome";var result=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);if(result!==null){webrtcDetectedVersion=parseInt(result[2],10)}else{webrtcDetectedVersion=999}window.createIceServer=function(b,e,a){var c=null;var d=b.split(":");if(d[0].indexOf("stun")===0){c={url:b}}else{if(d[0].indexOf("turn")===0){c={url:b,credential:a,username:e}}}return c};window.createIceServers=function(d,f,a){var e=[];if(webrtcDetectedVersion>=34){e={urls:d,credential:a,username:f}}else{for(var b=0;b<d.length;b++){var c=window.createIceServer(d[b],f,a);if(c!==null){e.push(c)}}}return e};RTCPeerConnection=function(a,b){if(webrtcDetectedVersion<34){maybeFixConfiguration(a)}return new webkitRTCPeerConnection(a,b)};getUserMedia=navigator.webkitGetUserMedia.bind(navigator);navigator.getUserMedia=getUserMedia;attachMediaStream=function(a,b){if(typeof a.srcObject!=="undefined"){a.srcObject=b}else{if(typeof a.mozSrcObject!=="undefined"){a.mozSrcObject=b}else{if(typeof a.src!=="undefined"){a.src=URL.createObjectURL(b)}else{console.log("Error attaching stream to element.")}}}};reattachMediaStream=function(b,a){b.src=a.src}}else{console.log("Browser does not appear to be WebRTC-capable")}}"use strict";if(window.MediaStreamTrack&&!MediaStreamTrack.getSources){MediaStreamTrack.getSources=MediaStreamTrack.getMediaDevices}var JCClient=function(J){J=J||{};var q=J.serverName||"https://stage.jumpch.at";var e=q+"/v1";var i={};var Q={};var I={};var ac={};var ae={};var U={};var G={};var h={};var H=false;var C=false;var m=J.audioBandwidth||50;var t=J.videoBandwidth||300;var r=J.videoBandwidthHD||2000;var S=J.dataBandwidth||30*1000*100;var Y=J.apiKey;var s=false;var ad={};var c=false;var n=false;var K=false;var k=null;var F="dpolibhkbcepgolajbfjfcakgdkfkfjg";var v="https://chrome.google.com/webstore/detail/dpolibhkbcepgolajbfjfcakgdkfkfjg";var X="https://addons.mozilla.org/firefox/downloads/latest/617104/addon-617104-latest.xpi";var P=false;var T=!!navigator.mozGetUserMedia;var V=navigator.userAgent.toLowerCase();var M=/android/.test(V);x(function(ah){P=ah});if(window.localStorage){n=localStorage.getItem("broadcastVideo")==null||localStorage.getItem("broadcastVideo")=="true";K=localStorage.getItem("broadcastAudio")==null||localStorage.getItem("broadcastAudio")=="true"}function A(){function ah(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return ah()+ah()+"-"+ah()+"-"+ah()+"-"+ah()+"-"+ah()+ah()+ah()}function ab(){if(J.userid){return J.userid}var ah=localStorage.getItem("userid");if(!ah){ah=A();localStorage.setItem("userid",ah)}return ah}function o(ah,aj,ai){return af(ah,0,-1,aj,ai)}function af(ai,an,ak,am,al){var aj=ak!==-1?ak:ai.length;for(var ah=an;ah<aj;++ah){if(ai[ah].indexOf(am)===0){if(!al||ai[ah].toLowerCase().indexOf(al.toLowerCase())!==-1){return ah}}}return null}function E(ah,ak){var aj=ah.split(" ");var al=aj.slice(0,3);al.push(ak);for(var ai=3;ai<aj.length;ai++){if(aj[ai]!==ak){al.push(aj[ai])}}return al.join(" ")}function R(ah,aj,ai){return L(ah,0,-1,aj,ai)}function L(ai,an,ak,am,al){var aj=ak!==-1?ak:ai.length;for(var ah=an;ah<aj;++ah){if(ai[ah].indexOf(am)===0){if(!al||ai[ah].toLowerCase().indexOf(al.toLowerCase())!==-1){return ah}}}return null}function y(ai,aj){var ah=R(ai,"a=rtpmap",aj);return ah?O(ai[ah]):null}function O(ai){var aj=new RegExp("a=rtpmap:(\\d+) \\w+\\/\\d+");var ah=ai.match(aj);return(ah&&ah.length===2)?ah[1]:null}function N(ah,ak,ai,al){var an=ak+" "+ai+" codec";if(al===""){console.log("No preference on "+an+".");return ah}console.log("Prefer "+an+": "+al);var aj=ah.split("\r\n");var ao=R(aj,"m=",ak);if(ao===null){return ah}var am=y(aj,al);if(am){aj[ao]=E(aj[ao],am)}ah=aj.join("\r\n");return ah}function w(ah){ah=ah.replace(/b=AS([^\r\n]+\r\n)/g,"");if(m){ah=ah.replace(/a=mid:audio\r\n/g,"a=mid:audio\r\nb=AS:"+m+"\r\n")}if(t){if(C){ah=ah.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+r+"\r\n")}else{ah=ah.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+t+"\r\n")}}if(S){ah=ah.replace(/a=mid:data\r\n/g,"a=mid:data\r\nb=AS:"+S+"\r\n")}return ah}function Z(aj,at){at=at||"";var ai=1024;var ap=atob(aj);var ar=ap.length;var ao=Math.ceil(ar/ai);var aq=new Array(ao);for(var ak=0;ak<ao;++ak){var ah=ak*ai;var al=Math.min(ah+ai,ar);var au=new Array(al-ah);for(var am=ah,an=0;am<al;++an,++am){au[an]=ap[am].charCodeAt(0)}aq[ak]=new Uint8Array(au)}return new Blob(aq,{type:at})}function l(ah){var ai=[];if(T){ai.push({url:"stun:stun.services.mozilla.com"})}else{ai.push({url:"stun:stun.l.google.com:19302"})}if(ah.turnIceServers){console.log("adding turnIceServers: "+JSON.stringify(ah.turnIceServers));ai=ai.concat(ah.turnIceServers)}ai={iceServers:ai};return ai}function z(){return{optional:[{DtlsSrtpKeyAgreement:true}],mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:true}}}function ag(ai,ah,aj){aj.onmessage=function(an){try{var ao=JSON.parse(an.data);if(ao.type=="text"){console.log("onmessage text: "+JSON.stringify(ao));b("chatMessage",[ah,ao.msg])}else{if(ao.type=="file"){var am=G[ao.id];if(!am){am=G[ao.id]={userid:ah,fileName:ao.fileName,mimeType:ao.mimeType,file:createJCFile(ao.fileName,ao.mimeType)}}am.file.appendBase64(ao.data);b("fileProgress",[ah,ao.id,ao.progress,ao.sent,ao.total]);if(ao.done){am.file.finish(function(){b("fileAdded",[ah,ao.id,am.file])});delete G[ao.id]}if(ao.ack){aj.send(JSON.stringify({type:"file_ack",id:ao.id}))}}else{if(ao.type=="file_ack"){var ak=h[ao.id];if(ak){ak.lastCount=ak.lastCountStart;g(ai,ah,ak)}}else{if(ao.type=="file_prompt"){console.log("onmessage file_prompt:");b("filePrompt",[ah,ao.file,function(ap){aj.send(JSON.stringify({type:"file_prompt_answer",file:ao.file,answer:ap}))}])}else{if(ao.type=="file_prompt_answer"){console.log("onmessage file_answer: "+JSON.stringify(ao));b("filePromptAnswer",[ah,ao.answer,ao.file]);if(ao.answer){ai._sendFile(ah,h[ao.file.id])}}else{if(ao.type=="file_cancel"){ai.cancelSendFiles(ao.id,true);b("fileCancel",[ah,ao.id])}else{if(ao.type=="broadcast_state"){console.log("onmessage broadcast_state: "+JSON.stringify(ao));i[ah].broadcastState=ao.state;b("broadcastState",[ah,ao.state])}else{if(ao.type=="update_name"){console.log("onmessage update_name: "+JSON.stringify(ao));i[ah].name=ao.name;b("updateName",[ah,ao.name])}else{if(ao.type=="update_avatar"){console.log("onmessage update_avatar: "+ah);var al=i[ah];if(ao.packetNum==1){al.avatarChunks=[]}al.avatarChunks.push(ao.avatar);if(ao.maxPackets==ao.packetNum){al.avatar=al.avatarChunks.join("");console.log("got avatar "+al.avatar);delete al.avatarChunks;b("updateAvatar",[ah,al.avatar])}}else{if(ao.type=="joined"){console.log("onmessage joined: "+ah);b("joined",[ah])}else{if(ao.type=="search"){console.log("onmessage search: "+ah);b("search",[ah,ao.q])}else{if(ao.type=="data_message"){console.log("onmessage data_message: "+ah);b("dataMessage",[ah,ao.msg])}}}}}}}}}}}}}catch(an){console.log(an)}};aj.onopen=function(){console.log("dc open");u(aj,n,K,ai.screenStream!=null);aj.send(JSON.stringify({type:"update_name",name:ai.username()}));var ak=ai.avatar();d(aj,ak,function(){aj.send(JSON.stringify({type:"joined"}))})};aj.onclose=function(){console.log("dc close")};aj.onerror=function(){console.log("dc error")}}function j(aj,ai){if(aj.roomSettings.mode=="mcu"){if(ai=="mcu"){ak=Q[ai]=aj.createPeerConnection(ai);W(aj,ak)}else{ak=Q[ai]=aj.createPeerConnection(ai);var ah=ac[ai]=ak.createDataChannel("jumpchat");ag(aj,ai,ah);I[ai]=true;W(aj,ak)}}else{var ak;if(Q[ai]){ak=Q[ai];if(aj.screenStream){ak.addStream(aj.screenStream)}if(aj.localStream){ak.addStream(aj.localStream);if(aj.localStream2){peer.addStream(this.localStream2)}}}else{ak=Q[ai]=aj.createPeerConnection(ai)}var ah=ac[ai]=ak.createDataChannel("jumpchat");ag(aj,ai,ah);I[ai]=true;W(aj,ak)}}function a(aj,ai,ah){var ak;if(aj=="hd"){ak={audio:true,video:n?{mandatory:{minWidth:1280,minHeight:720}}:false}}else{ak={audio:true,video:n?{mandatory:{maxWidth:640,maxHeight:480}}:false}}var ai=ai||localStorage.getItem("videoSourceId");var ah=ah||localStorage.getItem("audioSourceId");if(ai){ak.video.optional=[{sourceId:ai}]}if(ah){ak.audio={optional:[{sourceId:ah}]}}return ak}function W(ah,aj){var ak="";for(var ai in Q){if(aj==Q[ai]){ak=ai;break}}aj.createOffer(function(al){console.log("offer created");al.sdp=w(al.sdp);al.sdp=N(al.sdp,"video","send","H264/90000");al.sdp=N(al.sdp,"video","receive","H264/90000");aj.setLocalDescription(al,function(){var am={to:ak,sdp:{type:aj.localDescription.type,sdp:aj.localDescription.sdp}};console.log("offer: "+JSON.stringify(am));ah.socket.emit("webrtc",am)},console.error,z())},function(al){console.log(al)},z())}this.createPeerConnection=function(ak){var aj=l(this.roomSettings);var ai=new RTCPeerConnection(aj);var ah=this;ai.userid=ak;if(this.roomSettings.mode!="mcu"||ak=="mcu"){if(this.screenStream){ai.addStream(this.screenStream)}else{if(this.localStream){ai.addStream(this.localStream);if(this.localStream2){ai.addStream(this.localStream2)}}}}ai.onicecandidate=function(al){console.log("onicecandidate "+JSON.stringify(al.candidate));if(ah.roomSettings.mode=="mcu"){if(al.candidate==null){ah.socket.emit("webrtc",{to:ak.toString(),candidate:{completed:true}})}else{ah.socket.emit("webrtc",{to:ak.toString(),candidate:al.candidate})}}else{if(al.candidate){ah.socket.emit("webrtc",{to:ak.toString(),candidate:al.candidate})}}};ai.onaddstream=function(am){console.log("onaddstream");var al=document.createElement("video");ae[ak]=am.stream;al.setAttribute("stream",ak);b("remoteVideoAdded",[ak,am.stream.id,al]);attachMediaStream(al,am.stream);al.autoplay=true;al.play();if(am.stream.getVideoTracks().length==0){b("broadcastState",[ak,{video:false,audio:am.stream.getAudioTracks().length>0}])}};ai.onremovestream=function(al){console.log("remove stream");b("remoteVideoRemoved",[ak,al.stream.id])};ai.oniceconnectionstatechange=function(al){console.log("oniceconnectionstatechange = "+ai.iceConnectionState)};ai.onsignalingstatechange=function(al){console.log("onsignalingstatechange = "+ai.signalingState);if(ai.signalingState=="closed"){Q[ak]=null}};ai.ondatachannel=function(am){console.log("got data channel");var al=ac[ak]=am.channel;ag(ah,ak,al)};U[ak]=[];return ai};this.joinUrl=function(ak,aj,al,ah){var ai=this;$.ajax({dataType:"json",url:ak+"/settings",success:function(an){if(an.serverUrl!=""){e=an.serverUrl+"/v1"}ai.roomSettings=an;var ao=ai.roomSettings.room;var am=ai.roomSettings.type;ai._join(ao,am,aj,al,ah)},headers:{"X-API-Key":Y},error:function(ao,am,an){ah(ao.status,an)}})};this.join=function(al,ak,aj,am,ah){var ai=this;$.getJSON(q+"/api/1/settings/"+al,function(an){if(an.serverUrl!=""){e=an.serverUrl+"/v1"}ai.roomSettings=an;ai._join(al,ak,aj,am,ah)})};this._join=function(an,am,al,ao,ai){var ak=this;var ah=io.connect(e,{"force new connection":J.forceNew});this.socket=ah;this.room=an;this.roomType=am;var aj=ab();this.userid=aj;ah.on("connect",function(){console.log("on_connect");ah.emit("join",{room:an,userid:aj,password:al,type:am,apiKey:Y});H=true;if(ak.roomSettings.mode=="mcu"){j(ak,"mcu")}});ah.on("disconnect",function(){console.log("on_disconnect")});ah.on("users",function(at,ar){console.log("users: "+JSON.stringify(at));ak.sessid=ar;for(var aq in at){var ap=at[aq];i[ap.userid]=ap;if(ak.roomSettings.mode=="mcu"){if(ar!=ap.userid){j(ak,ap.userid)}}}ak.startBroadcasting();if(ao){ao(i)}});ah.on("joined",function(aq){console.log("joined: "+JSON.stringify(aq));var ap=aq.userid;i[ap]=aq;aq.newUser=true;j(ak,ap)});ah.on("left",function(aw){console.log("left: "+JSON.stringify(aw));var aq=aw.userid;if(Q[aq]==undefined){return}b("remoteVideoRemoved",[aq]);b("userLeft",[aq]);delete i[aq];var av=Q[aq];if(av){av.close()}delete Q[aq];delete ac[aq];delete ae[aq];var au=Object.keys(h);for(var at in au){var ap=au[at];var ar=h[ap];if(ar.userid==aq){delete h[ap];b("fileCancel",[aq,ap])}}au=Object.keys(G);for(var at in au){var ap=au[at];var ar=G[ap];if(ar.userid==aq){delete G[ap];b("fileCancel",[aq,ap])}}});ah.on("room",function(ap){k=ap.password;b("room",[ap]);console.log("room: "+JSON.stringify(ap))});ah.on("kicked",function(ap){b("kicked",[ap])});ah.on("locked",function(ap){b("locked",[ap])});ah.on("knocking",function(ap){b("knocking",[ap])});ah.on("knockAnswer",function(ap){b("knockAnswer",[ap])});ah.on("systemMessage",function(ap){b("systemMessage",[ap])});ah.on("webrtc",function(aq){console.log("webrtc: "+JSON.stringify(aq));var ar=aq.from;var ap=Q[ar];if(!ap){ap=Q[ar]=ak.createPeerConnection(ar)}if(aq.candidate){if(U[ar]){U[ar].push(aq.candidate)}else{var ap=Q[ar];ap.addIceCandidate(new RTCIceCandidate(aq.candidate),function(){},function(at){console.error(at)})}}else{if(aq.sdp){I[ar]=false;ap.setRemoteDescription(new RTCSessionDescription(aq.sdp),function(){console.log("remote desc set");if(ap.remoteDescription.type=="offer"){ap.createAnswer(function(at){at.sdp=w(at.sdp);at.sdp=N(at.sdp,"video","send","H264/90000");at.sdp=N(at.sdp,"video","receive","H264/90000");ap.setLocalDescription(at,function(){var au={to:ar,sdp:{type:ap.localDescription.type,sdp:ap.localDescription.sdp}};console.log("answer: "+JSON.stringify(au));ah.emit("webrtc",au)},console.error)},console.error,z())}ak.drainCandidates(ar,ap)},function(at){console.error(at)})}}})};this.disconnect=function(){console.log("rtc.disconnect");var ah=this;if(ah.socket){ah.socket.emit("leave")}for(var an in Q){b("remoteVideoRemoved",[an]);var am=Q[an];if(am){am.close()}var aj=ae[an];if(aj){var al=aj.getAudioTracks();for(var ai=0;ai<al.length;ai++){al[ai].stop()}var ak=aj.getVideoTracks();for(var ai=0;ai<ak.length;ai++){ak[ai].stop()}}}i={};Q={};ac={};ae={};H=false;return true};this.drainCandidates=function(ai,aj){console.log("drain candidates "+ai);var ah=U[ai];for(var ak in ah){aj.addIceCandidate(new RTCIceCandidate(ah[ak]),function(){},function(al){console.error(al)})}delete U[ai]};this.startBroadcasting=function(){console.log("start broadcasting");this.broadcasting=true};this.stopBroadcasting=function(){this.broadcasting=false;Q={}};function aa(ai,al,ah){var ak=document.createElement("video");ai.localStream=al;var am=ai.localStream.getAudioTracks();if(am.length>0){am[0].enabled=K}else{K=false}var aj=ai.localStream.getVideoTracks();if(aj.length>0){aj[0].enabled=n}else{n=false}al.me=ai.localStream;ak.autoplay=true;ak.muted=true;if(ah){ah(ak)}attachMediaStream(ak,al);ak.play()}this.enableHD=function(ak,ai){if(ak!=undefined){var al=localStorage.getItem("hd")=="true";if(al!=ak){localStorage.setItem("hd",ak);this.localStream.getVideoTracks()[0].stop();this.localStream=null;var aj=this;this.localVideo(function(am){b("localVideoUpdated",[aj.localStream]);for(var ao in Q){var an=Q[ao];an.removeStream(aj.localStream);W(aj,an);f(aj,an,aj.localStream)}if(ai){ai(localStorage.getItem("hd")=="true")}})}}var ah=localStorage.getItem("hd");return ah=="true"};this.enable2ndVideo=function(ai,ah){if(ai!=undefined){var aj=localStorage.getItem("video2");if(aj!=ai){localStorage.setItem("video2",ai)}}return localStorage.getItem("video2")=="true"};this.resetLocalVideo=function(ah){if(this.localStream&&this.localStream.getVideoTracks().length==1){this.localStream.getVideoTracks()[0].stop()}this.localStream=null;var ai=this;this.localVideo(function(aj){b("localVideoUpdated",[ai.localStream]);for(var al in Q){var ak=Q[al];ak.removeStream(ai.localStream);W(ai,ak);f(ai,ak,ai.localStream)}if(ah){ah()}})};this.setAudioSourceId=function(ah){if(ah==null||ah==""){localStorage.removeItem("audioSourceId")}else{localStorage.setItem("audioSourceId",ah)}};this.setVideoSourceId=function(ah){if(ah==null||ah==""){localStorage.removeItem("videoSourceId")}else{localStorage.setItem("videoSourceId",ah)}};this.localVideo=function(ah){var ai=this;if(this.localStream){var ak=document.createElement("video");ae.me=ai.localStream;D(this.localStream,ah,"local");return}var aj=localStorage.getItem("hd")=="true"?"hd":"sd";var al=a(aj);navigator.getUserMedia(al,function(am){C=aj=="hd";aa(ai,am,ah)},function(am){if(aj=="hd"){C=false;al=a("sd");navigator.getUserMedia(al,function(an){aa(ai,an,ah)},function(an){al.video=false;navigator.getUserMedia(al,function(ao){n=false;aa(ai,ao,ah)},function(ao){K=false;n=false;if(ah){ah(null)}})})}else{al.video=false;navigator.getUserMedia(al,function(an){n=false;aa(ai,an,ah)},function(an){K=false;n=false;if(ah){ah(null)}})}})};this.add2ndVideo=function(ak,ah){if(!this.localStream){return false}var aj=localStorage.getItem("hd")=="true"?"hd":"sd";var al=a(aj);al.audio=false;al.video.optional=[{sourceId:ak}];var ai=this;navigator.getUserMedia(al,function(ap){var ao=document.createElement("video");ao.autoplay=true;ao.muted=true;if(ah){ah(ao)}attachMediaStream(ao,ap);ao.play();ai.localStream2=ap;for(var an in Q){var am=Q[an];am.addStream(ap);W(ai,am)}},function(am){ah(null)})};this.remove2ndVideo=function(){if(this.localStream2){var ah=this;for(var aj in Q){var ai=Q[aj];ai.removeStream(this.localStream2);W(ah,ai)}this.localStream2=null}};this.on=function(ai,ah){ad[ai]=ah};function b(ai,aj){var ah=ad[ai];var ak=new Event(ai);aj=aj.slice(0);aj.unshift(ak);if(typeof(ah)=="function"){ah.apply(ak,aj)}}this.username=function(ai){if(ai||ai==""){localStorage.setItem("username",ai);for(var aj in ac){var ah=ac[aj];ah.send(JSON.stringify({type:"update_name",name:ai}))}}return localStorage.getItem("username")||""};function d(ai,aj,ah){var an=15*1000;var am=parseInt(aj.length/an)+1;var ak=0;function al(){var ao=aj.slice(0,an);aj=aj.slice(an);ai.send(JSON.stringify({type:"update_avatar",packetNum:ak+1,avatar:ao,maxPackets:am}));ak++;if(aj.length>0){setTimeout(al,100)}else{if(ah){ah()}}}al()}this.avatar=function(ai){if(ai){localStorage.setItem("avatar",ai);for(var aj in ac){var ah=ac[aj];d(ah,ai)}b("updateAvatar",["me",ai])}return localStorage.getItem("avatar")||window.staticUrl+"img/default-avatar.png"};this.user=function(ai){if(ai=="me"){ai=this.sessid;var ah=i[ai]||{};ah.avatar=this.avatar();ah.name=this.username();return ah}return i[ai]||{}};this.isSupported=function(){return navigator.getUserMedia!=null};this.sendChatMessage=function(aj,ah){console.log("sending msg: "+aj);if(ah){if(ac[ah]){ac[ah].send(JSON.stringify({type:"text",msg:aj}))}}else{for(var ai in Q){if(ac[ai]){ac[ai].send(JSON.stringify({type:"text",msg:aj}))}}}};this.sendFiles=function(ai,an){var ah=0;var ao=[];var am=[];var aj=[];for(var al=0;al<an.length;al++){ao.push(an[al].name);am.push(an[al].size);aj.push(an[al])}var ak={id:A(),files:aj,userid:ai};h[ak.id]=ak;if(ac[ai]){ac[ai].send(JSON.stringify({type:"file_prompt",file:{id:ak.id,names:ao,sizes:am}}))}return ak.id};this.cancelSendFiles=function(ak,ai,aj){var ah=h[ai];if(ah){ah.cancel=true;delete h[ai]}delete G[ai];if(!aj){var ak=ak;if(ac[ak]){ac[ak].send(JSON.stringify({type:"file_cancel",id:ai}))}}};function g(al,ak,ai){if(ai.cancel){return}var ao=ai.files[ai.index];var aj=ao.file.slice(ai.offset,ai.offset+ai.sliceSize);var ah=new FileReader();var am=0;for(var an=0;an<ai.index;an++){am+=ai.files[an].size}ah.readAsBinaryString(aj);ah.onloadend=function(){try{ai.offset+=aj.size;am+=ai.offset;var aq=btoa(ah.result);var ap=parseInt(am*100/ai.totalSize);ai.progress=ap;ac[ak].send(JSON.stringify({type:"file",id:ai.id,fileName:ao.name,mimeType:ao.type,ack:ai.lastCount==0,progress:ap,sent:am,total:ai.total,done:aj.size<ai.sliceSize,data:aq}));b("fileProgress",[ak,ai.id,ap,am,ai.totalSize]);ai.lastCount--;if(ai.lastCount>=0){setTimeout(function(){g(al,ak,ai)},0)}}catch(at){console.log(at)}var ar=false;if(aj.size<ai.sliceSize){ai.index++;ai.offset=0}if(ai.index<ai.files.length){ai.sendAgain=true}}}this._sendFile=function(aj,ah){var al=15*1024*(2/3);var ai=0;for(var ak=0;ak<ah.files.length;ak++){ai+=ah.files[ak].size}ah.totalSize=ai;ah.index=0;ah.offset=0;ah.sliceSize=al;ah.lastCountStart=20;ah.lastCount=ah.lastCountStart;g(this,aj,ah)};this.stream=function(ah){if(ah=="me"){return this.localStream}return ae[ah]};this.peers=function(){return Q};this.connected=function(){return H};this.users=function(){return i};this.admin=function(){var ah=i[this.sessid];if(ah){return ah.admin}return false};function u(ah,aj,ai,ak){if(ah){ah.send(JSON.stringify({type:"broadcast_state",state:{video:aj,audio:ai,screenShare:ak}}))}}this.broadcastAudio=function(aj){if(aj!=null){if(this.localStream){var ak=this.localStream.getAudioTracks();ak=ak.concat(this.screenStream?this.screenStream.getAudioTracks():[]);if(ak.length>0){K=aj;localStorage.setItem("broadcastAudio",K);for(var ai=0;ai<ak.length;ai++){ak[ai].enabled=K}}else{K=false}}else{K=false}for(var ah in Q){u(ac[ah],n,K,this.screenStream!=null)}b("broadcastState",["me",{video:n,audio:K,screenShare:this.screenStream!=null}])}return K};this.broadcastVideo=function(ak,ai){if(n==ak&&ai==null){return}if(ak!=null){if(this.localStream){var an=this.localStream.getVideoTracks();n=ak;localStorage.setItem("broadcastVideo",n);if(T){if(an[0]){an[0].enabled=n}}else{if(n){if(this.screenStream){this.screenStream.getVideoTracks()[0].enabled=true}else{var al={audio:true,video:{mandatory:{maxWidth:1280,maxHeight:720}}};var ar=this;for(var ao in Q){var aq=Q[ao];aq.removeStream(ar.localStream)}navigator.getUserMedia(al,function(av){av.getAudioTracks()[0].enabled=K;ar.localStream=av;b("localVideoUpdated",[ar.localStream]);for(var au in Q){var at=Q[au];at.addStream(ar.localStream);W(ar,at);f(ar,at,ar.localStream)}},function(at){console.error(at)})}}else{if(this.screenStream){this.screenStream.getVideoTracks()[0].enabled=false}else{var ap=this.localStream.getVideoTracks();if(ap.length>0){var aj=ap[0];aj.stop();this.localStream.removeTrack(aj)}}}}}else{if(this.screenStream){n=ak;this.screenStream.getVideoTracks()[0].enabled=n}else{n=false}}var ah=this.screenStream!=null;for(var am in Q){u(ac[am],n,K,ah)}b("broadcastState",["me",{video:n,audio:K,screenShare:ah}])}return n};var B=null;function f(ah,ai,aj){if(B!=null){return}B=setTimeout(function(){if(ai.signalingState=="stable"||ai.signalingState=="have-local-offer"){console.log("_resetLocalStream startOffer()");ai.addStream(aj);W(ah,ai);B=null}else{console.log("_resetLocalStream waiting 500ms");clearTimeout(B);B=null;f(ah,ai,aj)}},1000)}function p(ah,ak){for(var aj in Q){var ai=Q[aj];if(T){ai.close();Q[aj]=ah.createPeerConnection(aj)}if(ak){if(!T&&ah.localStream){ai.removeStream(ah.localStream)}W(ah,ai);f(ah,ai,ah.screenStream)}else{if(!T){ai.removeStream(ah.screenStream)}W(ah,ai);f(ah,ai,ah.localStream);ah.screenStream=null}}}function D(ak,ah,ai){var aj=document.createElement("video");aj.setAttribute("stream",ak.id);ah(aj,ai);attachMediaStream(aj,ak);aj.play()}function x(ah){if(T||M||!window.chrome||!window.chrome.runtime){ah(false);return}chrome.runtime.sendMessage(F,{getVersion:true},function(ai){if(!ai||!ai.version){console.warn("Extension not installed?: "+chrome.runtime.lastError);ah(false)}else{var aj=ai.version;console.log("Extension version is: "+aj);ah(true)}})}this.isSharingScreen=function(){return s};this.shareScreen=function(ah,ai){s=!s;var aj=this;if(!s){if(this.screenStream){var ak=this.screenStream.getVideoTracks()[0];ak.onended=null;ak.stop()}p(this,s);if(this.localStream){D(this.localStream,ah,"local");this.broadcastVideo(c)}else{this.broadcastVideo(false)}return}function al(ao,an){navigator.getUserMedia(ao,function(aq){aj.screenStream=aq;if(an&&aj.localStream){var ar=aj.localStream.getAudioTracks();if(ar&&ar.length>0){var ap=aj.localStream.getAudioTracks()[0];aq.addTrack(ap)}}aq.getVideoTracks()[0].onended=function(){console.log("stream ended");aj.shareScreen(ah)};p(aj,s);D(aq,ah,"screenshare");c=n;aj.broadcastVideo(true,true)},function(ap){s=false;ai(false)})}function am(){if(T){var ao=confirm("Do you want to share fullscreen?\n\nClick Ok to share full screen.\n\nClick Cancel to share windows.");var an=ao?"screen":"window";var ap={video:{mozMediaSource:an,mediaSource:an},audio:true};al(ap,false)}else{chrome.runtime.sendMessage(F,{getStream:true},function(aq){if(!aq){ai(chrome.runtime.lastError);P=false;return}console.log("Response from extension: "+JSON.stringify(aq));if(aq.streamId){var ar={};ar.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:aq.streamId,maxWidth:window.screen.width,maxHeight:window.screen.height,maxFrameRate:30}};al(ar,true)}else{s=false;ai("Extension failed to get the stream")}})}}if(aj.isExtensionInstalled()){am()}else{b("noExtension")}};this.isExtensionInstalled=function(){if(T){P=document.querySelectorAll(".jcffExtInstalled").length>0}return P};this.installExtension=function(ah,ai){if(T){setTimeout(function(){alert("You will need to reload after installing the addon");window.location.reload()},5000);window.location.href=X}else{var aj=this;chrome.webstore.install(v,function(ak){console.log("Extension installed successfully",ak);P=true;setTimeout(function(){aj.shareScreen(ah,ai)},1000)},function(ak){ai(ak);console.log("Failed to install the extension",ak)})}};this.sendDebugLog=function(ah,al,aj){var ai=navigator.userAgent;var ak={email:ah,msg:al,ua:navigator.userAgent,log:aj};this.socket.emit("debug_log",ak)};this.lockRoom=function(ah){this.socket.emit("lock",ah)};this.knock=function(ah){this.socket.emit("knock",{room:this.room,type:this.roomType,msg:ah})};this.knockAnswer=function(ai,ah){this.socket.emit("knockAnswer",{sessid:ai,answer:ah})};this.password=function(){return k};this.kick=function(ah){this.socket.emit("kick",ah)};this.getSources=function(ah){if(window.MediaStreamTrack){MediaStreamTrack.getSources(function(ai){ah(ai)})}else{ah([])}};this.doSearch=function(ai){console.log("search msg: "+ai);for(var ah in Q){if(ac[ah]){ac[ah].send(JSON.stringify({type:"search",q:ai}))}}};this.sendDataMessage=function(aj,ah){if(ah){if(ac[ah]){ac[ah].send(JSON.stringify({type:"data_message",msg:aj}))}}else{for(var ai in Q){if(ac[ai]){ac[ai].send(JSON.stringify({type:"data_message",msg:aj}))}}}};this.muteAudio=function(ah,aj){var ai=ae[ah];if(ai){ai.getAudioTracks()[0].enable=!aj}};this.muteVideo=function(ah,aj){var ai=ae[ah];if(ai){ai.getVideoTracks()[0].enable=!aj}}};var _fs;window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;if(window.requestFileSystem){window.requestFileSystem(window.TEMPORARY,1024*1024*1024*25,function(a){_fs=a},function(a){console.log(a)})}function createJCFile(a,b){if(_fs){return new JCFile(a,b)}else{return new JCFileMemory(a,b)}}function JCFile(b,c){this.queue=[];this.writing=false;this.type=c;this.name=b;var a=this;_fs.root.getDirectory("jc",{create:true},function(d){_fs.root.getFile("jc/"+b,{create:true},function(e){a.fileEntry=e;e.createWriter(function(f){a.fileWriter=f;console.log('File "jc/'+b+'" created');f.truncate(0);f.onerror=function(h){console.log("Write failed: "+h.toString());if(error){error(h)}};var g=false;f.onwriteend=function(){if(f.length==0){return}a.queue.shift();if(a.queue.length==0){a.writing=false}else{a._write()}}},function(f){console.log(f)})},function(f){console.log(f)})},function(d){console.log(d)});this.append=function(e){var d=new Blob([e],{type:this.type});this.appendBlob(d)};this.appendBase64=function(g){var f=atob(g);var h=new Array(f.length);for(var e=0;e<f.length;e++){h[e]=f.charCodeAt(e)}var d=new Uint8Array(h);this.append(d)};this.appendBlob=function(d){this.queue.push(d);if(!this.writing){this._write()}};this._write=function(){var d=this;this.writing=true;var f=this.queue[0];if(this.fileWriter){try{this.fileWriter.write(f)}catch(g){console.log("write failed");setTimeout(function(){d._write()},500)}}else{setTimeout(function(){d._write()},500)}};this.saveAs=function(){var d=this;var e=$("<a>").attr("download",d.name).attr("href",d.fileEntry.toURL());$(document.body).append(e);e[0].click();e.remove()};this.finish=function(d){var e=this;setTimeout(function(){if(e.writing){e.finish(d)}else{if(d){d()}}},500)}}function JCFileMemory(a,b){this.data=[];this.type=b;this.name=a;this.append=function(c){this.data.push(c)};this.appendBase64=function(f){var e=atob(f);var g=new Array(e.length);for(var d=0;d<e.length;d++){g[d]=e.charCodeAt(d)}var c=new Uint8Array(g);this.append(c)};this.appendBlob=function(e){var d=this;var c=new FileReader();c.readAsBinaryString(e);c.onloadend=function(){d.data.push(c.result)}};this.saveAs=function(){var c=new Blob(this.data,{type:this.type});saveAs(c,this.name)};this.finish=function(c){if(c){c()}}};